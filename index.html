<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Encryption App</title>
  </head>
  <body>
    <div id="app">
      <input type="file" id="fileInput" accept=".bin" />
      <div id="decryptedOutput"></div>
      <h1>Encrypt Message</h1>
      <input
        type="password"
        id="encryptPassword"
        placeholder="Enter Password"
      /><br />
      <textarea id="encryptMessage" cols="50" rows="4"></textarea><br />
      <button id="encryptButton">Encrypt</button><br />
      <div id="encryptedOutput"></div>

      <!-- <h1>Decrypt Message</h1>
      <input
        type="password"
        id="decryptPassword"
        placeholder="Enter Password"
      /><br />
      <textarea id="decryptMessage" cols="50" rows="4"></textarea><br />
      <button id="decryptButton">Decrypt</button>
      <div id="decryptedOutput"></div> -->
    </div>

    <script>
     const base64ToUInt8Array = (b64) =>
         Uint8Array.from(window.atob(b64), (c) => c.charCodeAt(0));
       const textToUInt8Array = (s) => new TextEncoder().encode(s);
       const Unt8ArrayToString = (u8) => String.fromCharCode.apply(null, u8);
       const UInt8ArrayToBase64 = (u8) => window.btoa(UInt8ArrayToString(u8)); 
      async function encryptMessage(message, password) {
        const key = await deriveKeyFromPassword(
          password,
          "HT24EFLxzRYATTG4PwMstxuIc6cnfnr4VjIeSJc9SMQ=",
          100000,
          256,
          "SHA-256"
        );

        const iv = window.crypto.getRandomValues(new Uint8Array(16));
        const ciphertext = new Uint8Array(
          await window.crypto.subtle.encrypt(
            {
              name: "AES-CTR",
              counter: iv,
              length: 128,
            },
            key,
            textToUInt8Array(message)
          )
        );

        const encryptedData = new Uint8Array(iv.length + ciphertext.length);
        encryptedData.set(iv);
        encryptedData.set(ciphertext, iv.length);

        return encryptedData;
      }
      async function decryptMessageFromBinary(encryptedData, password) {
        const key = await deriveKeyFromPassword(
          password,
          "HT24EFLxzRYATTG4PwMstxuIc6cnfnr4VjIeSJc9SMQ=",
          100000,
          256,
          "SHA-256"
        );

        const iv = encryptedData.slice(0, 16);
        const ciphertext = encryptedData.slice(16);
        const decryptedBuffer = await window.crypto.subtle.decrypt(
          {
            name: "AES-CTR",
            counter: iv,
            length: 128,
          },
          key,
          ciphertext
        );

        const decryptedMessage = new TextDecoder().decode(decryptedBuffer)
        return decryptedMessage;
      }
      // document
      //   .getElementById("fileInput")
      //   .addEventListener("change", async (event) => {
      //     const file = event.target.files[0];
      //     const decryptedMessage = await readFileAsArrayBuffer(file);
      //     document.getElementById(
      //       "decryptedOutput"
      //     ).innerText = `Decrypted Message: ${decryptedMessage}`;
      //   });

      // async function readFileAsArrayBuffer(file) {
      //   return new Promise((resolve, reject) => {
      //     const reader = new FileReader();
      //     reader.onload = () => resolve(reader.result);
      //     reader.onerror = reject;
      //     reader.readAsArrayBuffer(file);
      //   });
      // }

      // const base64ToUInt8Array = (b64) =>
      //   Uint8Array.from(window.atob(b64), (c) => c.charCodeAt(0));
      // const textToUInt8Array = (s) => new TextEncoder().encode(s);
      // const UInt8ArrayToString = (u8) => String.fromCharCode.apply(null, u8);
      // const UInt8ArrayToBase64 = (u8) => window.btoa(UInt8ArrayToString(u8));

      async function deriveKeyFromPassword(
        password,
        salt,
        iterations,
        keyLength,
        hash
      ) {
        const encoder = new TextEncoder();
        let keyMaterial = await crypto.subtle.importKey(
          "raw",
          encoder.encode(password),
          { name: "PBKDF2" },
          false,
          ["deriveKey"]
        );
        return await crypto.subtle.deriveKey(
          {
            name: "PBKDF2",
            salt: encoder.encode(salt),
            iterations: iterations,
            hash: hash,
          },
          keyMaterial,
          { name: "AES-CTR", length: keyLength },
          false,
          ["encrypt", "decrypt"]
        );
      }



      document.addEventListener("DOMContentLoaded", async () => {
        const encryptButton = document.getElementById("encryptButton");
        // const decryptButton = document.getElementById("decryptButton");

        encryptButton.addEventListener("click", async () => {
          const message = document.getElementById("encryptMessage").value;
          const password = document.getElementById("encryptPassword").value;

          try {
            const encryptedData = await encryptMessage(message, password);
            console.log("Encrypted Data:", encryptedData);
            const blob = new Blob([encryptedData]);
            saveAs(blob, "encrypted_message.bin");
            document.getElementById("encryptedOutput").innerText =
          "Message encrypted and saved as 'encrypted_message.bin'";
            // document.getElementById("encryptedOutput").innerText =
            //   `Encoded Message: ${JSON.stringify(encryptedData)}`.replace(
            //     /"/g,
            //     ""
            //   );
          } catch (error) {
            console.error("Encryption error:", error);
            document.getElementById("encryptedOutput").innerText =
              "Encryption failed. Please check your input.";
          }
        });

        // decryptButton.addEventListener("click", async () => {
        //   const fileInput = document.getElementById("fileInput");
        //   const file = fileInput.files[0];
        //   const password = document.getElementById("decryptPassword").value;

        //   try {
        //     const encryptedData = await readFileAsArrayBuffer(file);
        //     const decryptedMessage = await decryptMessageFromBinary(
        //       encryptedData,
        //       password
        //     );
        //     document.getElementById(
        //       "decryptedOutput"
        //     ).innerText = `Decrypted Message: ${decryptedMessage}`;
        //   } catch (error) {
        //     console.error("Decryption error:", error);
        //     document.getElementById("decryptedOutput").innerText =
        //       "Decryption failed. Please check your password.";
        //   }
        // });
        document.getElementById("fileInput").addEventListener("change", async (event) => {
      const file = event.target.files[0];
      const reader = new FileReader();

      reader.onload = async () => {
        const encryptedData = new Uint8Array(reader.result);
        const password = prompt("Enter password for decryption:");

        try {
          const decryptedMessage = await decryptMessageFromBinary(
            encryptedData,
            password
          );
          document.getElementById(
            "decryptedOutput"
          ).innerText = `Decrypted Message: ${decryptedMessage}`;
        } catch (error) {
          console.error("Decryption error:", error);
          document.getElementById("decryptedOutput").innerText =
            "Decryption failed. Please check your password.";
        }
      };

      reader.readAsArrayBuffer(file);
    });
      });
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js"></script>
  </body>
</html>
