<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="./style.css" />
    <title>Vite App</title>
  </head>
  <body>
    <div id="app">
      <h1>Encrypt Message</h1>
      <input
        type="password"
        id="encryptPassword"
        placeholder="Enter Password"
      /><br />
      <textarea id="encryptMessage" cols="50" rows="4"></textarea><br />
      <button onClick="encrypt()">Encrypt</button><br />
      <div id="encryptedOutput"></div>

      <h1>Decrypt message</h1>
      <input
        type="password"
        id="decryptPassword"
        placeholder="Enter Password"
      />
      <br />
      <textarea id="decryptMessage" cols="50" rows="4"></textarea><br />
      <button
        onclick="decrypt(document.getElementById('decryptMessage').value, document.getElementById('decryptPassword').value)"
      >
        Decrypt
      </button>
      <div id="decryptedOutput"></div>
    </div>
    <script>
      async function deriveKeyFromPassword(
        password,
        salt,
        iterations,
        keyLength,
        hash
      ) {
        const encoder = new TextEncoder();
        let keyMaterial = await crypto.subtle.importKey(
          "raw",
          encoder.encode(password),
          { name: "PBKDF2" },
          false,
          ["deriveKey"]
        );
        return await crypto.subtle.deriveKey(
          {
            name: "PBKDF2",
            salt: encoder.encode(salt),
            iterations: iterations,
            hash: hash,
          },
          keyMaterial,
          { name: "AES-CTR", length: keyLength },
          false,
          ["encrypt", "decrypt"]
        );
      }

      // AES encryption
      async function encrypt() {
        const message = document.getElementById("encryptMessage").value;
        const password = document.getElementById("encryptPassword").value;

        const encryptedBase64 = await encryptMessage(message, password);
        document.getElementById(
          "encryptedOutput"
        ).innerText = `Encoded Message: ${encryptedBase64}`;
      }

      async function decrypt() {
        const encryptedBase64 =
          document.getElementById("decryptedMessage").innerText;
        const password = document.getElementById("decryptedPassword").value;

        try {
          const decryptedMessage = await decryptMessageFromBase64(
            encryptedBase64,
            password
          );
          document.getElementById(
            "decryptedOutput"
          ).innerText = `Decrypted Message: ${decryptedMessage}`;
        } catch (error) {
          console.error("Decryption error:", error);
          document.getElementById("decodedMessage").innerText =
            "Decryption failed. Please check your password.";
        }
      }
      async function encryptMessage(message, password) {
        const encoder = new TextEncoder();
        const salt = crypto.getRandomValues(new Uint8Array(16));
        const iv = crypto.getRandomValues(new Uint8Array(16));
        const messageBuffer = encoder.encode(message);
        const key = await deriveKeyFromPassword(
          password,
          salt,
          100000,
          256,
          "SHA-256"
        );
        const counter = crypto.getRandomValues(new Uint8Array(16));
        const encryptedData = await crypto.subtle.encrypt(
          {
            name: "AES-CTR",
            counter: counter,
            length: 128,
          },
          key,
          messageBuffer
        );
        return (
          arrayBufferToBase64(salt) +
          arrayBufferToBase64(iv) +
          arrayBufferToBase64(counter) +
          arrayBufferToBase64(encryptedData)
        );
      }

      // AES encryption with Base64

      // AES decryption
      async function decrypt(encryptedBase64, password) {
        const salt = base64ToArrayBuffer(encryptedBase64.substring(0, 24));
        const iv = base64ToArrayBuffer(encryptedBase64.substring(24, 48));
        const encryptedData = base64ToArrayBuffer(
          encryptedBase64.substring(48)
        );
        const key = await deriveKeyFromPassword(
          password,
          salt,
          100000,
          256,
          "SHA-256"
        );
        const decryptedData = await crypto.subtle.decrypt(
          {
            name: "AES-CTR",
            counter: new Uint8Array(iv),
            iv: new Uint8Array(iv),
            length: 128,
          },
          key,
          encryptedData
        );
        return new TextDecoder().decode(decryptedData);
      }

      function arrayBufferToBase64(buffer) {
        let binary = "";
        const bytes = new Uint8Array(buffer);
        for (let i = 0; i < bytes.byteLength; i++) {
          binary += String.fromCharCode(bytes[i]);
        }
        return window.btoa(binary);
      }

      function base64ToArrayBuffer(base64String) {
        try {
          const binaryString = window.atob(base64String);
          const bytes = new Uint8Array(binaryString.length);
          for (let i = 0; i < binaryString.length; i++) {
            bytes[i] = binaryString.charCodeAt(i);
          }
          return bytes.buffer;
        } catch (error) {
          console.error("Error decoding base64 string:", error);
          return null;
        }
      }
    </script>
    <!-- <script type="module" src="/encryptation.js"></script> -->
  </body>
</html>
